"use strict";(()=>{var e={};e.id=891,e.ids=[891],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9710:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>d,patchFetch:()=>f,requestAsyncStorage:()=>u,routeModule:()=>l,serverHooks:()=>_,staticGenerationAsyncStorage:()=>p});var n={};t.r(n),t.d(n,{POST:()=>c});var i=t(9303),a=t(8716),o=t(670),s=t(7070);async function c(e){let r=function(e){let r=e.headers.get("x-bbox-fid");if(!r)return null;let t=Number(r);return Number.isFinite(t)?t:null}(e);if(!r)return s.NextResponse.json({error:"Missing FID (x-bbox-fid header)"},{status:401});await Object(function(){var e=Error("Cannot find module '@/lib/user'");throw e.code="MODULE_NOT_FOUND",e}())(r);let{user:t,stats:n}=await Object(function(){var e=Error("Cannot find module '@/lib/user'");throw e.code="MODULE_NOT_FOUND",e}())(r),i=null;if(n.free_picks_remaining>0)i="free";else if(n.extra_picks_balance>0)i="extra";else{let e=new Date,t=n.next_free_refill_at;return t||(t=new Date(e.getTime()+864e5).toISOString(),await Object(function(){var e=Error("Cannot find module '@/lib/supabaseServer'");throw e.code="MODULE_NOT_FOUND",e}()).from("user_stats").update({next_free_refill_at:t}).eq("fid",r)),s.NextResponse.json({error:"No picks left",nextFreeRefillAt:t},{status:400})}let a=Object(function(){var e=Error("Cannot find module '@/lib/gameLogic'");throw e.code="MODULE_NOT_FOUND",e}())(),o=Object(function(){var e=Error("Cannot find module '@/lib/gameLogic'");throw e.code="MODULE_NOT_FOUND",e}())(a),c=new Date,l={total_points:n.total_points+o,updated_at:c.toISOString()};"free"===i?l.free_picks_remaining=n.free_picks_remaining-1:l.extra_picks_balance=n.extra_picks_balance-1,("free"===i&&0===l.free_picks_remaining&&0===n.extra_picks_balance||"extra"===i&&0===n.free_picks_remaining&&0===l.extra_picks_balance)&&(l.next_free_refill_at=new Date(c.getTime()+864e5).toISOString());let{data:u,error:p}=await Object(function(){var e=Error("Cannot find module '@/lib/supabaseServer'");throw e.code="MODULE_NOT_FOUND",e}()).from("user_stats").update(l).eq("fid",r).select("*").single();if(p)return console.error("pick update error",p),s.NextResponse.json({error:"Failed to update stats"},{status:500});let{error:_}=await Object(function(){var e=Error("Cannot find module '@/lib/supabaseServer'");throw e.code="MODULE_NOT_FOUND",e}()).from("picks").insert({fid:r,points:o,rarity:a,pick_type:i,created_at:c.toISOString()});return _&&console.error("pick insert error",_),s.NextResponse.json({rarity:a,points:o,totalPoints:u.total_points,freePicksRemaining:u.free_picks_remaining,extraPicksBalance:u.extra_picks_balance,nextFreeRefillAt:u.next_free_refill_at})}(function(){var e=Error("Cannot find module '@/lib/supabaseServer'");throw e.code="MODULE_NOT_FOUND",e})(),function(){var e=Error("Cannot find module '@/lib/user'");throw e.code="MODULE_NOT_FOUND",e}(),function(){var e=Error("Cannot find module '@/lib/gameLogic'");throw e.code="MODULE_NOT_FOUND",e}();let l=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/pick/route",pathname:"/api/pick",filename:"route",bundlePath:"app/api/pick/route"},resolvedPagePath:"/workspaces/bbox/src/app/api/pick/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:u,staticGenerationAsyncStorage:p,serverHooks:_}=l,d="/api/pick/route";function f(){return(0,o.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:p})}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),n=r.X(0,[948,972],()=>t(9710));module.exports=n})();